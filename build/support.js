// Generated by CoffeeScript 1.7.1
$(function() {
  var chats, chatsEl, createChatEl, createMessageEl, messageQueue, sendMessage, supportName, supportStaff, time, update, userName, users;
  time = null;
  chatsEl = $('<div id="chats" />').appendTo('body');
  users = {};
  supportStaff = {};
  chats = {};
  messageQueue = [];
  sendMessage = function(message, userId) {
    return messageQueue.push({
      message: message,
      userId: userId
    });
  };
  userName = function(id) {
    if (users[id].name) {
      return users[id].name;
    } else {
      return users[id].email;
    }
  };
  supportName = function(id) {
    var _ref, _ref1;
    return (_ref = (_ref1 = supportStaff[id]) != null ? _ref1.name : void 0) != null ? _ref : 'Support';
  };
  createChatEl = function(userId) {
    var chatEl;
    chatEl = $("<div class='chat'> <span class='user'>" + (userName(userId)) + "</span> <div class='wrapper'> <div class='messages' /> </div> <input type='text' class='sendMessage'> </div>").appendTo(chatsEl);
    chatEl.find('.sendMessage').keyup(function(e) {
      if (e.keyCode === 13) {
        sendMessage(this.value, userId);
        return this.value = '';
      }
    });
    return chatEl;
  };
  createMessageEl = function(message) {
    var sender;
    sender = null;
    if (message.sender) {
      sender = supportName(message.sender);
    } else {
      sender = userName(message.user_id);
    }
    return $("<div class='message'> <span class='sender'>" + sender + "</span><span class='content'>" + message.content + "</span> </div>");
  };
  update = function() {
    $.post('http://ext.agora.sh/supportUpdate.php?id=' + supportStaffId, {
      time: time != null ? time : 0,
      messages: messageQueue
    }, (function(response) {
      var chatEl, message, supportStaffMember, user, _i, _j, _k, _len, _len1, _len2, _ref, _ref1, _ref2;
      time = response.time;
      _ref = response.users;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        user = _ref[_i];
        users[user.id] = user;
      }
      _ref1 = response.supportStaff;
      for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
        supportStaffMember = _ref1[_j];
        supportStaff[supportStaffMember.id] = supportStaffMember;
      }
      _ref2 = response.messages;
      for (_k = 0, _len2 = _ref2.length; _k < _len2; _k++) {
        message = _ref2[_k];
        if (!chats[message.user_id]) {
          chatEl = createChatEl(message.user_id);
          chatEl.css({
            left: (chatsEl.find('.chat').length - 1) * chatEl.width()
          });
          chats[message.user_id] = {
            el: chatEl
          };
        }
        chats[message.user_id].el.find('.messages').append(createMessageEl(message));
      }
      return setTimeout((function() {
        return update();
      }), 1000);
    }), 'json');
    return messageQueue = [];
  };
  return update();
});

//# sourceMappingURL=support.map
